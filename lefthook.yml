---
# Git hooks manager - https://lefthook.dev/
min_version: 1.10.0 # required for glob_matcher: doublestar
glob_matcher: doublestar
rc: ./scripts/lefthook-rc.sh

output:
  - summary
  - failure
  - success

pre-commit:
  parallel: true
  skip: [merge, rebase]
  files: >-
    sh -c '{ git diff --name-only --cached 2>/dev/null;
    git diff --name-only 2>/dev/null;
    git ls-files --others --exclude-standard; } | sort -u'

  jobs:
    - name: formatting
      priority: 1
      group:
        jobs:
          - name: nix-fmt
            tags: [formatting]
            run: nix fmt -- --fail-on-change
            fail_text: "Formatting differs. Run: nix fmt"

    - name: linting
      priority: 2
      group:
        parallel: true
        jobs:
          - name: deadnix
            tags: [nix]
            glob: "**/*.nix"
            run: deadnix --fail -- {files}
            fail_text: "Unused Nix bindings found. Remove dead code shown above."

          - name: statix
            tags: [nix]
            glob: "**/*.nix"
            run: lefthook-statix {files}
            fail_text: "Nix anti-patterns found. Run: statix fix <file>"

          - name: actionlint
            tags: [ci]
            glob: ".github/workflows/*.{yml,yaml}"
            run: actionlint {files}
            fail_text: "GitHub Actions workflow issues found."

          - name: shellcheck
            tags: [shell]
            glob: "**/*.sh"
            run: shellcheck {files}
            fail_text: "Shell script issues found."

    - name: file-hygiene
      priority: 3
      run: lefthook-file-hygiene {files}
      fail_text: "File hygiene issues found (trailing whitespace, missing EOF newline, merge conflicts, or invalid JSON/YAML)."
